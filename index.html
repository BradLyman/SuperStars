<!doctype html>
<html>
<head>
  <title>Stars</title>
  <script src="/socket.io/socket.io.js"         ></script>
  <script src="randomColor.js"                  ></script>
  <script type="text/javascript" src="p5.min.js"></script>
  <script>
    var
      points = {},
      socket = io(),
      userColor = randomColor({
        luminosity : 'bright',
        format     : 'rgbArray'
      });

    function setup() {
      createCanvas( windowWidth, windowHeight );
    }

    function draw() {
      background( 240 );

      Object.keys( points ).forEach( function( key ){
        var point = points[ key ];

        if ( point != null ) {
          star(
            point.x * windowWidth,
            point.y * windowHeight,
            point.innerRadius,
            point.outerRadius,
            point.points,
            point.color,
            point.scale
          );
        }
      });
    }

    function mousePressed() {
      var point = createPoint( mouseX / windowWidth, mouseY / windowHeight );
      addPoint( point, true );
    }

    function touchStarted() {
      var point = createPoint( touchX / windowWidth, touchY / windowHeight );
      addPoint( point, true );
      return false;
    }

    socket.on( 'newPoint', function( point ){
      addPoint( point, false );
    });

    function createPoint( x, y ) {
      var getRandomInt = function( min, max ) {
        return Math.floor( Math.random() * (max - min) ) + min;
      };

      return {
        x           : x,
        y           : y,
        points      : getRandomInt( 3, 8 ),
        innerRadius : getRandomInt( 10, 20 ),
        outerRadius : getRandomInt( 30, 60 ),
        color       : userColor,
        scale       : 1.0
      };
    };

    var disappear = function( toKill ){
      var point = points[ toKill ];
      if ( !point ) {
        return;
      }

      point.scale -= 0.025;

      if ( point.scale <= 0 ) {
        points[ toKill ] = null;
      }

      setTimeout( function() {
        disappear( toKill );
      }, 50 );
    };


    var addPoint = (function() {
      var
        index = 0,
        getRandomInt;

      return function( point, isNew ) {
        var kill = index;

        points[ index ] = point;

        if ( isNew ) {
          socket.emit( 'newPoint', points[ index ] );
        }

        setTimeout( function() {
          disappear( kill );
        }, 2000 );

        index += 1;
      };
    }());

    function star( x, y, radius1, radius2, npoints, color, size ) {
      var
        a, sx, sy,
        angle = TWO_PI / npoints,
        halfAngle = angle / 2.0;

      push();
      translate( x, y );
      scale( size, size );
      fill( color[ 0 ], color[ 1 ], color[ 2 ] );
      beginShape();
      for ( a = 0; a < TWO_PI; a += angle ) {
        sx = cos( a ) * radius2;
        sy = sin( a ) * radius2;
        vertex( sx, sy );

        sx = cos( a + halfAngle ) * radius1;
        sy = sin( a + halfAngle ) * radius1;
        vertex( sx, sy );
      }
      endShape( CLOSE );
      pop();
    }
  </script>
</head>

<body>
</body>
</html>
